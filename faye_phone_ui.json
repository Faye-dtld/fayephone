<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
<title>聊天界面 (完整版)</title>
<!-- 引入 Google Fonts 手写字体 -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Dancing+Script:wght@700&family=Ma+Shan+Zheng&display=swap" rel="stylesheet">
<style>
/* CSS变量定义 */
:root {
--interface-bg: rgba(247, 247, 247, 0.6);
--msg-name-color: #999999;
--msg-time-color: #b0b0b0;
}

/* CSS样式 */
body {
font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
display: flex;
justify-content: center;
align-items: center;
margin: 0;
background-color: transparent;
user-select: none;
-webkit-user-select: none;
min-height: 100vh;
overflow: hidden;
}

/* 手机容器 */
#phone-container {
width: 320px;
height: 660px;
max-width: 95vw;
max-height: 95vh;
border: 8px solid #707070; /* 默认深紫色 */
border-radius: 50px;
background: #707070;
background-size: cover;
background-position: center;
box-shadow:
inset 0 0 0 2px rgba(0,0,0,0.1),
0 20px 50px rgba(0, 0, 0, 0.3);
display: flex;
flex-direction: column;
overflow: hidden;
position: relative;
transition: width 0.3s, height 0.3s, border-color 0.3s;
box-sizing: content-box;
}

/* Home Indicator */
#home-indicator {
position: absolute;
bottom: 8px;
left: 50%;
transform: translateX(-50%);
width: 130px;
height: 5px;
background-color: #000;
border-radius: 10px;
z-index: 200;
pointer-events: none;
}

/* --- 灵动岛 --- */
.status-bar {
position: absolute; top: 0; left: 0; width: 100%; height: 50px;
display: flex; justify-content: space-between; align-items: flex-start;
padding-top: 14px; padding-left: 26px; padding-right: 26px; box-sizing: border-box;
z-index: 100; font-size: 14px; font-weight: 600; pointer-events: none; transition: color 0.3s;
}
.status-bar.text-dark { color: #000; } .status-bar.text-dark svg { fill: #000; }
.status-bar.text-light { color: #fff; } .status-bar.text-light svg { fill: #fff; }
.sb-left { width: 60px; text-align: center; }
.sb-right { width: 60px; display: flex; justify-content: center; align-items: center; gap: 6px; }
.dynamic-island {
width: 96px; height: 28px; background-color: #000; border-radius: 14px;
position: absolute; left: 50%; top: 10px; transform: translateX(-50%); z-index: 101;
display: flex; justify-content: flex-end; align-items: center; padding-right: 10px; pointer-events: auto;
}
.island-camera {
width: 10px; height: 10px; background: #1a1a1a; border-radius: 50%;
box-shadow: inset 0 0 3px rgba(255,255,255,0.2);
}

/* --- 屏幕管理 --- */
.screen {
flex: 1; display: flex; flex-direction: column; width: 100%; height: 100%;
position: absolute; top: 0; left: 0; background-size: cover; background-position: center;
transition: transform 0.4s cubic-bezier(0.19, 1, 0.22, 1), opacity 0.4s, filter 0.4s;
overflow: hidden;
background-color: #fff;
}
#home-screen {
z-index: 1; padding-top: 0;
align-items: center;
justify-content: center;
background-color: #f3e5f5;
transform: translateX(0); opacity: 1;
}
#home-screen.slide-out {
transform: translateX(-30%);
opacity: 0.8;
filter: brightness(0.8);
pointer-events: none;
}

/* 主屏幕时间 */
#home-clock {
font-family: 'Dancing Script', 'Ma Shan Zheng', cursive, sans-serif;
font-size: 60px;
letter-spacing: 4px;
color: #4a3b5e;
margin-bottom: 80px;
font-weight: normal;
text-shadow: 0 2px 5px rgba(0,0,0,0.1);
z-index: 5;
}

/* 子页面 */
#chat-screen, #settings-screen {
z-index: 10;
transform: translateX(100%);
box-shadow: -5px 0 15px rgba(0,0,0,0.05);
}
#chat-screen.visible, #settings-screen.visible {
transform: translateX(0);
}

.app-grid {
display: grid; grid-template-columns: repeat(4, 1fr); gap: 25px 15px; padding: 0 24px; width: 100%; box-sizing: border-box;
margin-bottom: 50px;
}
.app-item { display: flex; flex-direction: column; align-items: center; gap: 8px; cursor: pointer; position: relative; }
.app-item:active { opacity: 0.7; transform: scale(0.95); transition: 0.1s; }
.app-icon-box {
width: 60px; height: 60px; border-radius: 16px; display: flex; align-items: center; justify-content: center;
background: #e6e6fa;
transition: background 0.3s;
box-shadow: none;
opacity: 0.72;
}
.app-icon-box svg { width: 32px; height: 32px; transition: fill 0.3s; fill: #483d8b; }
.app-icon-image {
width: 32px; height: 32px;
background-color: #483d8b;
-webkit-mask-size: contain; -webkit-mask-repeat: no-repeat; -webkit-mask-position: center;
mask-size: contain; mask-repeat: no-repeat; mask-position: center;
transition: background-color 0.3s;
}
.app-name { font-size: 12px; font-weight: 500; text-shadow: 0 1px 3px rgba(0,0,0,0.3); color: #4a3b5e; }

/* Header */
.app-header {
height: 80px; padding-top: 40px;
display: flex; align-items: center;
padding-left: 15px; padding-right: 15px;
background-color: var(--interface-bg);
backdrop-filter: blur(10px);
border-bottom: 1px solid rgba(0,0,0,0.05);
flex-shrink: 0; z-index: 10; box-sizing: border-box;
transition: background-color 0.3s;
}
.header-content { display: flex; align-items: center; justify-content: center; width: 100%; height: 100%; position: relative; }
.header-btn { width: 40px; height: 40px; display: flex; align-items: center; justify-content: flex-start; cursor: pointer; position: absolute; left: 0; }
.header-btn svg { width: 24px; height: 24px; fill: #181818; }
.header-title { font-size: 17px; font-weight: 600; color: #181818; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; text-align: center; max-width: 70%; }

/* Chat Area */
#chat-messages {
flex: 1; padding: 15px; overflow-y: auto; display: flex; flex-direction: column; gap: 12px;
scroll-behavior: smooth; scrollbar-width: none;
}
#chat-messages::-webkit-scrollbar { display: none; }

.settings-body {
flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 15px;
background: #f2f2f7;
}
.settings-body::-webkit-scrollbar { display: none; }

/* Message Styles */
.message-row { display: flex; align-items: flex-start; gap: 8px; width: 100%; flex-shrink: 0; }
.message-row.sent { flex-direction: row-reverse; }
.message-row.received { flex-direction: row; }
.avatar { width: 38px; height: 38px; border-radius: 6px; background-color: #e0e0e0; object-fit: cover; flex-shrink: 0; border: 1px solid rgba(0,0,0,0.05); margin-top: 0; }

.msg-container { display: flex; flex-direction: column; max-width: 75%; }
.message-row.sent .msg-container { align-items: flex-end; }
.message-row.received .msg-container { align-items: flex-start; }

.msg-name {
font-size: 12px; color: var(--msg-name-color);
margin: 0 2px 2px 2px; max-width: 100%; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
}

.msg-wrapper {
display: flex; flex-direction: row; align-items: flex-end; gap: 3px; margin-top: 2px;
}
.message-row.sent .msg-wrapper { flex-direction: row-reverse; }
.message-row.received .msg-wrapper { flex-direction: row; }

.msg-thought {
font-size: 12px; color: #333; background-color: rgba(200, 200, 200, 0.3);
border-radius: 14px; padding: 4px 8px; margin-top: 1px;
line-height: 1.3; word-wrap: break-word; max-width: 100%; box-sizing: border-box;
text-align: left;
}

.bubble, .location-card, .transfer-card, .file-card, .voice-card, .photo-card, .sticker-bubble {
flex-shrink: 0; cursor: pointer; position: relative; transition: transform 0.1s; max-width: 100%;
}
.bubble.pressing, .location-card.pressing, .transfer-card.pressing, .file-card.pressing, .voice-card.pressing, .photo-card.pressing, .sticker-bubble.pressing {
transform: scale(0.98); filter: brightness(0.95);
}

.bubble {
padding: 7px 14px; border-radius: 18px; line-height: 1.5; word-wrap: break-word; font-size: 14px;
opacity: 0.8;
}
.bubble-sent {
background: #dcd0ff; color: #000; border-top-right-radius: 0px;
}
.bubble-received {
background: #ffffff; color: #000; box-shadow: 0 1px 1px rgba(0, 0, 0, 0.05); border-top-left-radius: 0px;
}

.msg-time {
font-size: 10px; color: var(--msg-time-color); line-height: 1; user-select: none; padding: 0 2px; margin-bottom: 2px; flex-shrink: 0; min-width: 28px;
}
.message-row.sent .msg-time { text-align: right; }
.message-row.received .msg-time { text-align: left; }

.photo-card { border-radius: 6px; overflow: visible; box-shadow: 0 2px 5px rgba(0,0,0,0.1); font-size: 0; }
.photo-card img { width: 100%; height: auto; display: block; border-radius: 6px; }

.sticker-bubble { border-radius: 14px; overflow: visible; box-shadow: 0 2px 5px rgba(0,0,0,0.1); font-size: 0; max-width: 80px; }
.sticker-bubble img { width: 100%; height: auto; display: block; border-radius: 14px; }

.voice-card {
padding: 7px 12px; border-radius: 18px; display: flex; flex-direction: column; gap: 4px; min-width: 28px; position: relative;
}
.voice-card.sent { background: #dcd0ff; color: #000; border-top-right-radius: 0px; }
.voice-card.received { background: #ffffff; color: #000; box-shadow: 0 1px 1px rgba(0, 0, 0, 0.05); border-top-left-radius: 0px; }

.voice-bar { display: flex; align-items: center; gap: 8px; height: 20px; }
.voice-card.sent .voice-bar { flex-direction: row-reverse; }
.voice-duration { font-size: 14px; font-weight: 500; min-width: 25px; text-align: center; }
.voice-waves { display: flex; align-items: center; gap: 3px; height: 100%; flex: 1; }
.wave { width: 2px; background-color: currentColor; border-radius: 1px; opacity: 0.8; }
.voice-text {
font-size: 13px; padding-top: 8px; border-top: 1px solid rgba(0,0,0,0.1); display: none; white-space: pre-wrap; line-height: 1.4; text-align: left; word-break: break-all;
}
.voice-card.show-text .voice-text { display: block; }
.voice-card.sent .voice-text { text-align: right; }
.voice-card.sent .voice-text.multiline { text-align: left; }

.location-card, .transfer-card, .file-card { width: 200px; overflow: visible; }
.location-card { background: white; border-radius: 6px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); border: 1px solid #eee; }
.location-info { padding: 8px 10px; background: #fff; border-top-left-radius: 6px; border-top-right-radius: 6px; }
.location-name { font-size: 13px; color: #333; font-weight: 500; margin: 0; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.location-map { width: 100%; height: 60px; background-color: #f2f2f2; background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="220" height="90" viewBox="0 0 220 90"><rect width="220" height="90" fill="%23f2f2f2"/><path d="M-10,30 Q50,10 110,30 T230,30" stroke="%23ddd" stroke-width="6" fill="none"/><path d="M30,90 Q60,50 90,90" stroke="%23ddd" stroke-width="6" fill="none"/><path d="M150,0 Q180,40 210,0" stroke="%23ddd" stroke-width="6" fill="none"/><circle cx="110" cy="45" r="4" fill="%23ea4e3d"/></svg>'); background-size: cover; background-position: center; display: flex; align-items: center; justify-content: center; border-bottom-left-radius: 6px; border-bottom-right-radius: 6px; }
.location-pin { width: 20px; height: 20px; fill: #ea4e3d; filter: drop-shadow(0 2px 2px rgba(0,0,0,0.2)); margin-bottom: 8px; }

.transfer-card { background: #ffacac; border-radius: 6px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
.transfer-top { padding: 12px; display: flex; align-items: center; gap: 10px; border-top-left-radius: 6px; border-top-right-radius: 6px; }
.transfer-icon-circle { width: 36px; height: 36px; border-radius: 50%; border: 2px solid #fff; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
.transfer-icon-circle svg { width: 20px; height: 20px; stroke: #fff; stroke-width: 2; fill: none; }
.transfer-content { flex: 1; color: #fff; display: flex; flex-direction: column; overflow: hidden; }
.transfer-amount { font-size: 15px; font-weight: bold; }
.transfer-note { font-size: 11px; opacity: 0.9; margin-top: 1px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.transfer-bottom { background: #fff; padding: 4px 12px; font-size: 10px; color: #999; border-bottom-left-radius: 6px; border-bottom-right-radius: 6px; }

.file-card { background: white; border-radius: 6px; padding: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); display: flex; align-items: center; gap: 10px; border: 1px solid #eee; }
.file-info { flex: 1; overflow: hidden; }
.file-name { font-size: 13px; color: #333; font-weight: 500; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; line-height: 1.3; word-break: break-all; }
.file-size { font-size: 9px; color: #999; margin-top: 3px; }
.file-icon { width: 34px; height: 34px; flex-shrink: 0; }
.file-icon svg { width: 100%; height: 100%; fill: #ddd; }

/* Input Bar */
#input-bar {
display: flex; padding: 8px 8px;
border-top: none; /* No white line */
background-color: var(--interface-bg);
backdrop-filter: blur(10px);
align-items: flex-end; flex-shrink: 0; z-index: 10;
padding-bottom: 20px;
transition: background-color 0.3s;
}
#input-bar textarea {
flex: 1; border: none; border-radius: 20px; padding: 8px 12px;
font-size: 15px; resize: none; max-height: 80px; outline: none; min-height: 20px;
background: #fff; color: #000; /* Ensure text is black */
margin-right: 4px;
}

.toolbar-btn {
background: #e5e5e5; color: #333; border: none;
width: 36px; height: 36px;
display: flex; align-items: center; justify-content: center; flex-shrink: 0;
cursor: pointer; transition: background 0.2s;
margin-bottom: 2px; border-radius: 50%;
}
.toolbar-btn:hover { background: #d1d1d1; }
.toolbar-btn svg { width: 22px; height: 22px; fill: #333; }

#plus-button { margin-right: 6px; padding: 0; }
#emoji-button { margin-left: 4px; margin-right: 4px; }

#send-button {
background: #e5e5e5; color: #333; border-radius: 18px;
height: 36px; padding: 0 12px; font-size: 14px; font-weight: 600;
margin-left: 2px; margin-bottom: 2px; width: auto;
display: flex; align-items: center; justify-content: center;
border: none; cursor: pointer; transition: background 0.2s; flex-shrink: 0;
}
#send-button:hover { background: #d1d1d1; }

/* Menus */
#action-menu, #emoji-menu {
height: 0; background: #f7f7f7; border-top: none; transition: height 0.2s ease; overflow: hidden;
flex-shrink: 0; z-index: 10;
}
#action-menu { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; padding: 0 20px; }
#action-menu.open { height: 220px; padding: 25px 20px; border-top: 1px solid #e5e5e5; }
#emoji-menu { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; padding: 0 12px; overflow-y: auto; box-sizing: border-box; }
#emoji-menu.open { height: 220px; padding: 15px 12px; border-top: 1px solid #e5e5e5; }
#emoji-menu::-webkit-scrollbar { display: none; }

.action-item { display: flex; flex-direction: column; align-items: center; gap: 8px; cursor: pointer; color: #666; font-size: 12px; }
.action-icon-box { width: 55px; height: 55px; background: #fff; border-radius: 16px; display: flex; align-items: center; justify-content: center; border: 1px solid #e5e5e5; }

.sticker-item { display: flex; flex-direction: column; align-items: center; cursor: pointer; }
.sticker-img { width: 60px; height: 60px; object-fit: cover; border-radius: 8px; background: #fff; }
.sticker-name { font-size: 10px; color: #666; margin-top: 4px; text-align: center; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; width: 100%; }

/* Modals */
.modal-overlay {
position: absolute; top: 0; left: 0; width: 100%; height: 100%;
background: rgba(0,0,0,0.4); display: flex; justify-content: center; align-items: center;
z-index: 200; opacity: 0; pointer-events: none; transition: opacity 0.2s;
}
#input-modal { z-index: 210; } /* Ensure input modal is on top */
.modal-overlay.show { opacity: 1; pointer-events: auto; }
.modal-box {
width: 280px; background: #fff; border-radius: 12px; padding: 20px;
box-shadow: 0 10px 30px rgba(0,0,0,0.2); display: flex; flex-direction: column; gap: 15px;
transform: scale(0.9); transition: transform 0.2s; max-height: 85%; overflow-y: auto; scrollbar-width: none;
}
.modal-overlay.show .modal-box { transform: scale(1); }
.modal-title { font-size: 18px; font-weight: bold; color: #333; border-bottom: 1px solid #eee; padding-bottom: 10px; margin-bottom: 5px; }
.modal-actions { display: flex; justify-content: flex-end; gap: 10px; margin-top: 10px; }
.modal-btn { padding: 8px 16px; border-radius: 6px; font-size: 14px; cursor: pointer; border: none; font-weight: 500; }
.btn-cancel { background: #f0f0f0; color: #333; }
.btn-confirm { background: #07c160; color: white; }
.btn-grey { background: #e5e5e5; color: #333; } .btn-grey:active { background: #d1d1d1; }

#modal-inputs-container { display: flex; flex-direction: column; gap: 12px; }
.modal-input { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 15px; box-sizing: border-box; outline: none; }
.modal-input:focus { border-color: #07c160; }

/* Settings UI */
.settings-section-title { font-size: 12px; color: #999; font-weight: bold; text-transform: uppercase; margin-top: 10px; margin-bottom: 5px; }
.setting-group { background: #fff; border-radius: 8px; padding: 0; display: flex; flex-direction: column; border: 1px solid #e5e5e5; overflow: hidden; }
.setting-row {
display: grid; grid-template-columns: 1fr auto; align-items: center; font-size: 15px; color: #000; gap: 10px;
padding: 12px 15px; border-bottom: 1px solid #f0f0f0;
}
.setting-row:last-child { border-bottom: none; }
.setting-row > div { display: flex; align-items: center; gap: 8px; justify-content: flex-end; }
.color-picker { width: 28px; height: 28px; border: 1px solid #ddd; padding: 0; border-radius: 50%; overflow: hidden; cursor: pointer; }
.color-picker::-webkit-color-swatch-wrapper { padding: 0; }
.color-picker::-webkit-color-swatch { border: none; border-radius: 50%; }
.setting-input-sm { width: 50px; padding: 4px; border: 1px solid #ddd; border-radius: 4px; text-align: center; }
.file-upload-label {
font-size: 12px; background: #f2f2f7; border: 1px solid #ddd; padding: 5px 10px;
border-radius: 14px; cursor: pointer; display: inline-flex; align-items: center;
transition: background 0.2s; appearance: none; color: #333; font-family: inherit;
}
.file-upload-label:active { background: #e5e5ea; }
.file-upload-input { display: none; }
.preview-img { width: 32px; height: 32px; border-radius: 6px; object-fit: cover; background: #eee; border: 1px solid #ddd; }

.delete-btn {
position: absolute; top: -6px; right: -6px; width: 18px; height: 18px;
background-color: #c0c0c0; color: #fff; border-radius: 50%;
display: flex; align-items: center; justify-content: center; cursor: pointer; z-index: 10;
}
.delete-btn svg { width: 10px; height: 10px; stroke: currentColor; stroke-width: 3; }
.typing-dots span {
display: inline-block; width: 6px; height: 6px; background-color: #888;
border-radius: 50%; margin: 0 2px; animation: typing 1.4s infinite ease-in-out both;
}
.typing-dots span:nth-child(1) { animation-delay: -0.32s; }
.typing-dots span:nth-child(2) { animation-delay: -0.16s; }
@keyframes typing { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1); } }
</style>
<script type="importmap">
{
  "imports": {
    "react": "https://aistudiocdn.com/react@^19.2.0",
    "react-dom/": "https://aistudiocdn.com/react-dom@^19.2.0/",
    "react/": "https://aistudiocdn.com/react@^19.2.0/",
    "lucide-react": "https://aistudiocdn.com/lucide-react@^0.554.0"
  }
}
</script>
</head>
<body>
<div id="phone-container">
<div id="home-indicator"></div>
<div class="status-bar text-dark" id="status-bar">
<div class="sb-left" id="clock">12:00</div>
<div class="dynamic-island"><div class="island-camera"></div></div>
<div class="sb-right">
<svg width="22" height="11" viewBox="0 0 22 11" fill="currentColor">
<path d="M4 5 l1.5 2.5 h-3 z" />
<path d="M4 11 l-1.5 -2.5 h3 z" />
<path d="M7 5.5h2v6H7v-6zm4-3h2v9H11v-9zm4-3h2v12h-2V-.5z"></path>
</svg>
<svg width="22" height="11" viewBox="0 0 25 11" fill="currentColor"><rect x="0.5" y="0.5" width="20" height="10" rx="2.5" stroke="currentColor"></rect><path d="M23 4v3" stroke="currentColor" stroke-width="2" stroke-linecap="round"></path><rect x="2.5" y="2.5" width="16" height="6" rx="1" fill="currentColor"></rect></svg>
</div>
</div>
<div id="home-screen" class="screen">
<div id="home-clock">12:00</div>
<div class="app-grid">
<div class="app-item" onclick="openChat()">
<div class="app-icon-box app-icon-style"><div class="app-icon-image" style="-webkit-mask-image: url('https://api.iconify.design/basil:wechat-solid.svg'); mask-image: url('https://api.iconify.design/basil:wechat-solid.svg');"></div></div>
<span class="app-name">聊天</span>
</div>
<div class="app-item">
<div class="app-icon-box app-icon-style"><div class="app-icon-image" style="-webkit-mask-image: url('https://api.iconify.design/simple-icons:qzone.svg'); mask-image: url('https://api.iconify.design/simple-icons:qzone.svg');"></div></div>
<span class="app-name">朋友圈</span>
</div>
<div class="app-item">
<div class="app-icon-box app-icon-style"><div class="app-icon-image" style="-webkit-mask-image: url('https://api.iconify.design/material-symbols:forum-rounded.svg'); mask-image: url('https://api.iconify.design/material-symbols:forum-rounded.svg');"></div></div>
<span class="app-name">论坛</span>
</div>
<div class="app-item">
<div class="app-icon-box app-icon-style"><div class="app-icon-image" style="-webkit-mask-image: url('https://api.iconify.design/ep:eleme-filled.svg'); mask-image: url('https://api.iconify.design/ep:eleme-filled.svg');"></div></div>
<span class="app-name">饿了么</span>
</div>
<div class="app-item">
<div class="app-icon-box app-icon-style"><div class="app-icon-image" style="-webkit-mask-image: url('https://api.iconify.design/fa-brands:discord.svg'); mask-image: url('https://api.iconify.design/fa-brands:discord.svg');"></div></div>
<span class="app-name">Discord</span>
</div>
<div class="app-item">
<div class="app-icon-box app-icon-style"><div class="app-icon-image" style="-webkit-mask-image: url('data:image/svg+xml;utf8,<svg xmlns=\'http://www.w3.org/2000/svg\' viewBox=\'0 0 24 24\'><text x=\'50%25\' y=\'50%25\' dy=\'.35em\' font-family=\'Arial\' font-weight=\'900\' font-size=\'14\' text-anchor=\'middle\'>ST</text></svg>'); mask-image: url('data:image/svg+xml;utf8,<svg xmlns=\'http://www.w3.org/2000/svg\' viewBox=\'0 0 24 24\'><text x=\'50%25\' y=\'50%25\' dy=\'.35em\' font-family=\'Arial\' font-weight=\'900\' font-size=\'14\' text-anchor=\'middle\'>ST</text></svg>');"></div></div>
<span class="app-name">SillyTavern</span>
</div>
<div class="app-item" onclick="openSettings()">
<div class="app-icon-box app-icon-style"><svg viewBox="0 0 24 24"><path d="M19.14 12.94c.04-.3.06-.61.06-.94 0-.32-.02-.64-.07-.94l2.03-1.58c.18-.14.23-.41.12-.61l-1.92-3.32c-.12-.22-.37-.29-.59-.22l-2.39.96c-.5-.38-1.03-.7-1.62-.94l-.36-2.54c-.04-.24-.24-.41-.48-.41h-3.84c-.24 0-.43.17-.47.41l-.36 2.54c-.59.24-1.13.57-1.62.94l-2.39-.96c-.22-.08-.47 0-.59.22L3.16 8.87c-.12.21-.08.47.12.61l2.03 1.58c-.05.3-.09.63-.09.94s.02.64.07.94l-2.03 1.58c-.18.14-.23.41-.12.61l1.92 3.32c.12.22.37.29.59.22l2.39-.96c.5.38 1.03.7 1.62.94l.36 2.54c.05.24.24.41.48.41h3.84c.24 0 .44-.17.47-.41l.36-2.54c.59-.24 1.13-.58 1.62-.94l2.39.96c.22.08.47 0 .59-.22l1.92-3.32c.12-.22.07-.47-.12-.61l-2.01-1.58zM12 15.6c-1.98 0-3.6-1.62-3.6-3.6s1.62-3.6 3.6-3.6 3.6 1.62 3.6 3.6-1.62 3.6-3.6 3.6z"></path></svg></div>
<span class="app-name">设置</span>
</div>
</div>
</div>
<div id="chat-screen" class="screen">
<div class="app-header">
<div class="header-content">
<div class="header-btn" onclick="goBack()"><svg viewBox="0 0 24 24"><path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"></path></svg></div>
<span class="header-title" id="header-title">{{char}}</span>
</div>
</div>
<div id="chat-messages"></div>
<div id="input-bar">
<button id="plus-button" class="toolbar-btn" title="更多功能"><svg viewBox="0 0 24 24"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"></path></svg></button>
<textarea id="message-input" placeholder="输入消息..." rows="1"></textarea>
<button id="emoji-button" class="toolbar-btn"><svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm3.5-9c.83 0 1.5-.67 1.5-1.5S16.33 8 15.5 8 14 8.67 14 9.5s.67 1.5 1.5 1.5zm-7 0c.83 0 1.5-.67 1.5-1.5S9.33 8 8.5 8 7 8.67 7 9.5 7.67 11 8.5 11zm3.5 6.5c2.33 0 4.31-1.46 5.11-3.5H6.89c.8 2.04 2.78 3.5 5.11 3.5z"></path></svg></button>
<button id="send-button">发送</button>
</div>
<input type="file" id="photo-upload-input" accept="image/*" style="display: none;">
<input type="file" id="voice-upload-input" accept="audio/*" style="display: none;">
<div id="action-menu">
<div class="action-item" onclick="handleAction('photo')"><div class="action-icon-box"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#333" stroke-width="1.5"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><circle cx="8.5" cy="8.5" r="1.5"></circle><polyline points="21 15 16 10 5 21"></polyline></svg></div><span>照片</span></div>
<div class="action-item" onclick="handleAction('voice')"><div class="action-icon-box"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#333" stroke-width="1.5"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path><path d="M19 10v2a7 7 0 0 1-14 0v-2"></path><line x1="12" y1="19" x2="12" y2="23"></line><line x1="8" y1="23" x2="16" y2="23"></line></svg></div><span>语音</span></div>
<div class="action-item" onclick="handleAction('location')"><div class="action-icon-box"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#333" stroke-width="1.5"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path><circle cx="12" cy="10" r="3"></circle></svg></div><span>位置</span></div>
<div class="action-item" onclick="handleAction('transfer')"><div class="action-icon-box"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#333" stroke-width="1.5"><path d="M7 10h14l-4-4"></path><path d="M17 14H3l4 4"></path></svg></div><span>转账</span></div>
<div class="action-item" onclick="openChatSettings()"><div class="action-icon-box"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#333" stroke-width="1.5"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg></div><span>设置</span></div>
<div class="action-item" onclick="handleAction('file')"><div class="action-icon-box"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#333" stroke-width="1.5"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg></div><span>文件</span></div>
</div>
<div id="emoji-menu"></div>
</div>
<div id="settings-screen" class="screen">
<div class="app-header">
<div class="header-content">
<div class="header-btn" onclick="closeSettings()"><svg viewBox="0 0 24 24"><path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"></path></svg></div>
<span class="header-title">手机设置</span>
</div>
</div>
<div class="settings-body">
<div class="settings-section-title" style="margin-top:0">外观与硬件</div>
<div class="setting-group">
<div class="setting-row"><label>手机尺寸 (宽x高)</label> <div><input type="number" id="set-phone-w" class="setting-input-sm" placeholder="350"> x <input type="number" id="set-phone-h" class="setting-input-sm" placeholder="650"></div></div>
<div class="setting-row"><label>手机壳颜色</label> <input type="color" id="set-case-color" class="color-picker"></div>
</div>
<div class="settings-section-title">主屏幕</div>
<div class="setting-group">
<div class="setting-row"><label>自定义时间 (HH:MM)</label> <input type="text" id="set-custom-time" class="setting-input-sm" style="width: 80px;" placeholder="空则自动"></div>
<div class="setting-row"><label>主屏壁纸</label> <div><button class="file-upload-label" onclick="handleUploadUrl('home-bg')">输入链接</button> <img id="preview-home-bg" class="preview-img" src=""></div></div>
<div class="setting-row"><label>图标底色</label> <input type="color" id="set-icon-bg" class="color-picker"></div>
<div class="setting-row"><label>图标图案颜色</label> <input type="color" id="set-icon-color" class="color-picker"></div>
<div class="setting-row"><label>字体颜色</label> <input type="color" id="set-home-text-color" class="color-picker"></div>
</div>
<div class="modal-actions" style="justify-content: center; margin-top: 30px; padding-bottom: 30px;">
<button class="modal-btn btn-grey" style="width: 100%; padding: 12px;" onclick="saveHomeSettings()">保存并应用</button>
</div>
</div>
</div>
<div id="input-modal" class="modal-overlay">
<div class="modal-box">
<div class="modal-title" id="modal-title">输入内容</div>
<div id="modal-inputs-container"></div>
<div class="modal-actions"><button class="modal-btn btn-cancel" onclick="closeModal()">取消</button><button class="modal-btn btn-confirm" id="modal-confirm-btn">发送</button></div>
</div>
</div>
<div id="chat-settings-modal" class="modal-overlay">
<div class="modal-box">
<div class="modal-title">聊天设置</div>
<div class="setting-group">
<div class="setting-row"><label>聊天背景</label> <div><button class="file-upload-label" onclick="handleUploadUrl('chat-bg')">输入链接</button> <img id="preview-chat-bg" class="preview-img" src=""></div></div>
<div class="setting-row"><label>界面颜色</label> <div><input type="color" id="set-interface-color" class="color-picker"></div></div>
<div class="setting-row"><label>对方气泡/文字</label> <div><input type="color" id="set-char-bubble" class="color-picker"> <input type="color" id="set-char-text" class="color-picker"></div></div>
<div class="setting-row"><label>对方头像</label> <div><button class="file-upload-label" onclick="handleUploadUrl('char-avatar')">输入链接</button> <img id="preview-char-avatar" class="preview-img" src=""></div></div>
<div class="setting-row"><label>我方气泡/文字</label> <div><input type="color" id="set-user-bubble" class="color-picker"> <input type="color" id="set-user-text" class="color-picker"></div></div>
<div class="setting-row"><label>我方头像</label> <div><button class="file-upload-label" onclick="handleUploadUrl('user-avatar')">输入链接</button> <img id="preview-user-avatar" class="preview-img" src=""></div></div>
<div class="setting-row"><label>名字/时间颜色</label> <div><input type="color" id="set-msg-name-color" class="color-picker"> <input type="color" id="set-msg-time-color" class="color-picker"></div></div>
</div>
<div class="modal-actions"><button class="modal-btn btn-cancel" onclick="closeModal()">取消</button><button class="modal-btn btn-confirm" onclick="saveChatSettings()">保存配置</button></div>
</div>
</div>
</div>
<script>
(function() {
// Global Variables
let appSettings = {
charBubble: '#FFC9CB', charText: '#474747', charAvatar: '',
userBubble: '#FFA8AC', userText: '#5C5C5C', userAvatar: '',
chatBg: 'https://file.zhuyitai.com/feedback/202511/22/96c39311d8df6d1d6a89984630585a70.jpeg', chatBgIsDark: false,
homeBg: 'https://intellcs.sinosafe.com.cn/immessage/api/v1/message/attachment/download?groupName=group1&authorization=EnAfMjUzaQVz&fileName=M00/00/A7/CgND1WkhtDSADV5WAANPQ4JuHoI63.jpeg', homeBgIsDark: false,
iconBg: '#003673', iconColor: '#00885A',
caseColor: '#707070', phoneWidth: '320', phoneHeight: '660',
homeTextColor: '#749594',
interfaceColor: '#ffc7c8',
msgNameColor: '#858585',
msgTimeColor: '#999999',
customTime: '' // 格式 HH:MM，为空则使用系统时间
};

const stickerList = [
{ name: "你自首吧", url: "https://files.catbox.moe/s1wpw8.jpeg" },
{ name: "抱抱", url: "https://files.catbox.moe/31onrh.jpeg" },
{ name: "贴贴", url: "https://files.catbox.moe/ljqszc.jpeg" },
{ name: "占有欲", url: "https://files.catbox.moe/6j9ltv.jpeg" },
{ name: "我兴奋起来了", url: "https://files.catbox.moe/y9vuz2.jpeg" },
{ name: "等待回复", url: "https://files.catbox.moe/8zf3tp.jpeg" },
{ name: "晚安", url: "https://files.catbox.moe/bamzp5.jpeg" },
{ name: "竖起耳朵听", url: "https://files.catbox.moe/bddzgj.jpeg" },
{ name: "夸我", url: "https://files.catbox.moe/1okcpc.jpeg" },
{ name: "自闭", url: "https://files.catbox.moe/vhrl2c.jpeg" },
{ name: "棒", url: "https://files.catbox.moe/vug6x5.jpeg" },
{ name: "急死我了", url: "https://files.catbox.moe/ygvldi.jpeg" },
{ name: "硬撑", url: "https://files.catbox.moe/pxagvt.jpeg" },
{ name: "悄悄出现", url: "https://files.catbox.moe/znwuf4.jpeg" },
{ name: "你是坏东西", url: "https://files.catbox.moe/g5bnhu.jpeg" },
{ name: "无语", url: "https://files.catbox.moe/zgjnrv.jpeg" },
{ name: "我想开了", url: "https://files.catbox.moe/xvhtbt.jpeg" },
{ name: "我没电了", url: "https://files.catbox.moe/4vrfsv.jpeg" },
{ name: "上吊", url: "https://files.catbox.moe/2hjg2o.jpeg" },
{ name: "流鼻血", url: "https://files.catbox.moe/qq2py6.jpeg" },
{ name: "亲亲老婆", url: "https://files.catbox.moe/vptaso.jpeg" },
{ name: "永远追随我的大小姐", url: "https://files.catbox.moe/n79kdr.jpeg" },
{ name: "破防", url: "https://files.catbox.moe/mph3am.jpeg" },
{ name: "放弃", url: "https://files.catbox.moe/cd70ix.jpeg" },
{ name: "吃惊", url: "https://files.catbox.moe/ye5iim.jpeg" },
{ name: "探头看", url: "https://files.catbox.moe/5mnp9k.jpeg" },
{ name: "在吗", url: "https://files.catbox.moe/81owmg.jpeg" },
{ name: "大小姐该起床了", url: "https://files.catbox.moe/zu6bov.jpeg" },
{ name: "你说什么听不见", url: "https://files.catbox.moe/frahng.jpeg" },
{ name: "小狗来啦", url: "https://files.catbox.moe/f04vhn.jpeg" },
{ name: "得意小狗", url: "https://files.catbox.moe/j2ad7t.jpeg" },
{ name: "做错事的小狗", url: "https://files.catbox.moe/k0rjk5.jpeg" },
{ name: "认真小狗", url: "https://files.catbox.moe/u3gjq1.jpeg" },
{ name: "迷恋送花", url: "https://files.catbox.moe/kq696u.jpeg" },
{ name: "回味聊天记录哭哭", url: "https://files.catbox.moe/8ml56z.jpeg" }
];

let activeDeleteBtn = null;
let currentConfirmAction = null;

// DOM Elements (Initialized in init to be safe)
let phoneContainer, homeScreen, chatScreen, settingsScreen, chatMessages, messageInput, sendButton, plusButton, emojiButton, actionMenu, emojiMenu, modal, modalTitle, modalInputsContainer, modalConfirmBtn, chatSettingsModal, headerTitle, clockEl, homeClockEl, statusBar, photoInput;

// Functions
function openChat() {
if(homeScreen) homeScreen.classList.add('slide-out');
if(chatScreen) chatScreen.classList.add('visible');
updateStatusBar('chat');
setTimeout(() => { if(chatMessages) chatMessages.scrollTop = chatMessages.scrollHeight; }, 300);
}

function goBack() {
closeMenus();
if(chatScreen) chatScreen.classList.remove('visible');
if(homeScreen) homeScreen.classList.remove('slide-out');
updateStatusBar('home');
}

function openSettings() {
document.getElementById('set-phone-w').value = appSettings.phoneWidth;
document.getElementById('set-phone-h').value = appSettings.phoneHeight;
document.getElementById('set-case-color').value = appSettings.caseColor;
document.getElementById('set-icon-bg').value = appSettings.iconBg;
document.getElementById('set-icon-color').value = appSettings.iconColor;
document.getElementById('set-home-text-color').value = appSettings.homeTextColor;
document.getElementById('set-custom-time').value = appSettings.customTime || '';
document.getElementById('preview-home-bg').src = appSettings.homeBg || '';

if(homeScreen) homeScreen.classList.add('slide-out');
if(settingsScreen) settingsScreen.classList.add('visible');
updateStatusBar('settings');
}

function closeSettings() {
if(settingsScreen) settingsScreen.classList.remove('visible');
if(homeScreen) homeScreen.classList.remove('slide-out');
updateStatusBar('home');
}

function updateClock() {
let timeStr;
if (appSettings.customTime && /^\d{1,2}:\d{2}$/.test(appSettings.customTime)) {
    timeStr = appSettings.customTime;
} else {
    const now = new Date();
    timeStr = `${now.getHours().toString().padStart(2,'0')}:${now.getMinutes().toString().padStart(2,'0')}`;
}
if(clockEl) clockEl.textContent = timeStr;
if(homeClockEl) homeClockEl.textContent = timeStr;
}

function updateStatusBar(screen) {
let isDark = false;
if (screen === 'home') isDark = appSettings.homeBgIsDark;
else if (screen === 'chat') isDark = appSettings.chatBgIsDark;
else if (screen === 'settings') isDark = false;

if (screen === 'home' && !appSettings.homeBg) isDark = false;
if (screen === 'chat' && !appSettings.chatBg) isDark = false;

if(statusBar) statusBar.className = isDark ? 'status-bar text-light' : 'status-bar text-dark';
}

function analyzeImageBrightness(base64) {
return new Promise((resolve) => {
if (!base64) { resolve(false); return; }
const img = new Image();
img.crossOrigin = 'Anonymous';
img.src = base64;
img.onload = () => {
const canvas = document.createElement('canvas'); canvas.width = 50; canvas.height = 50;
const ctx = canvas.getContext('2d'); ctx.drawImage(img, 0, 0, 50, 50);
try {
const data = ctx.getImageData(0,0,50,50).data; let r=0,g=0,b=0;
for(let i=0; i<data.length; i+=4) { r+=data[i]; g+=data[i+1]; b+=data[i+2]; }
resolve(((r+g+b)/(3*(data.length/4))) < 128);
} catch (e) { resolve(false); }
};
img.onerror = () => resolve(false);
});
}

function loadSettings() {
const saved = localStorage.getItem('st-phone-settings');
if (saved) { try { appSettings = { ...appSettings, ...JSON.parse(saved) }; } catch(e) {} }
}
function saveSettingsToStorage() { localStorage.setItem('st-phone-settings', JSON.stringify(appSettings)); }

function hexToRgba(hex, alpha) {
let r = 0, g = 0, b = 0;
if (hex.length === 4) {
r = parseInt("0x" + hex[1] + hex[1]);
g = parseInt("0x" + hex[2] + hex[2]);
b = parseInt("0x" + hex[3] + hex[3]);
} else if (hex.length === 7) {
r = parseInt("0x" + hex[1] + hex[2]);
g = parseInt("0x" + hex[3] + hex[4]);
b = parseInt("0x" + hex[5] + hex[6]);
}
return `rgba(${r},${g},${b},${alpha})`;
}

function applySettings() {
if(phoneContainer) {
phoneContainer.style.width = (appSettings.phoneWidth || 350) + 'px';
phoneContainer.style.height = (appSettings.phoneHeight || 650) + 'px';
phoneContainer.style.borderColor = appSettings.caseColor;
phoneContainer.style.backgroundColor = appSettings.caseColor; // 修复圆角缝隙：背景色跟随手机壳颜色
}
if(homeScreen) {
if (appSettings.homeBg) homeScreen.style.backgroundImage = `url(${appSettings.homeBg})`;
else { homeScreen.style.backgroundImage = 'none'; homeScreen.style.backgroundColor = '#f3e5f5'; }
}
if(chatScreen) {
if (appSettings.chatBg) { chatScreen.style.backgroundImage = `url(${appSettings.chatBg})`; chatScreen.style.backgroundColor = '#f9f9f9'; }
else { chatScreen.style.backgroundImage = 'none'; chatScreen.style.backgroundColor = '#fff'; }
}

document.querySelectorAll('.app-icon-style').forEach(el => {
el.style.background = appSettings.iconBg;
const svg = el.querySelector('svg');
if (svg) svg.style.fill = appSettings.iconColor;
const mask = el.querySelector('.app-icon-image');
if (mask) mask.style.backgroundColor = appSettings.iconColor;
});

if (appSettings.homeTextColor) {
if(homeClockEl) homeClockEl.style.color = appSettings.homeTextColor;
document.querySelectorAll('.app-name').forEach(el => el.style.color = appSettings.homeTextColor);
}

const rootStyle = document.documentElement.style;
const rgba = hexToRgba(appSettings.interfaceColor || '#f7f7f7', 0.6);
rootStyle.setProperty('--interface-bg', rgba);
rootStyle.setProperty('--msg-name-color', appSettings.msgNameColor || '#999999');
rootStyle.setProperty('--msg-time-color', appSettings.msgTimeColor || '#b0b0b0');

updateStatusBar('home'); loadInitialChat();
}

function handleUploadUrl(targetId) {
openModal('输入图片链接', [{ placeholder: 'https://...' }], (values) => {
const url = values[0];
if (url) {
const el = document.getElementById('preview-' + targetId);
if (el) el.src = url;
}
});
}

async function saveHomeSettings() {
appSettings.phoneWidth = document.getElementById('set-phone-w').value || 350;
appSettings.phoneHeight = document.getElementById('set-phone-h').value || 650;
appSettings.caseColor = document.getElementById('set-case-color').value;
appSettings.iconBg = document.getElementById('set-icon-bg').value;
appSettings.iconColor = document.getElementById('set-icon-color').value;
appSettings.homeTextColor = document.getElementById('set-home-text-color').value;
appSettings.customTime = document.getElementById('set-custom-time').value;

const homeBgUrl = document.getElementById('preview-home-bg').src;
if (homeBgUrl && homeBgUrl !== window.location.href) {
appSettings.homeBg = homeBgUrl;
appSettings.homeBgIsDark = await analyzeImageBrightness(appSettings.homeBg);
}
saveSettingsToStorage(); applySettings(); closeSettings();
}

function openChatSettings() {
document.getElementById('set-char-bubble').value = appSettings.charBubble;
document.getElementById('set-char-text').value = appSettings.charText;
document.getElementById('set-user-bubble').value = appSettings.userBubble;
document.getElementById('set-user-text').value = appSettings.userText;
document.getElementById('preview-char-avatar').src = appSettings.charAvatar;
document.getElementById('preview-user-avatar').src = appSettings.userAvatar;
document.getElementById('preview-chat-bg').src = appSettings.chatBg || '';
document.getElementById('set-interface-color').value = appSettings.interfaceColor || '#f7f7f7';
document.getElementById('set-msg-name-color').value = appSettings.msgNameColor || '#999999';
document.getElementById('set-msg-time-color').value = appSettings.msgTimeColor || '#b0b0b0';
chatSettingsModal.classList.add('show');
}

async function saveChatSettings() {
appSettings.charBubble = document.getElementById('set-char-bubble').value;
appSettings.charText = document.getElementById('set-char-text').value;
appSettings.userBubble = document.getElementById('set-user-bubble').value;
appSettings.userText = document.getElementById('set-user-text').value;
appSettings.interfaceColor = document.getElementById('set-interface-color').value;
appSettings.msgNameColor = document.getElementById('set-msg-name-color').value;
appSettings.msgTimeColor = document.getElementById('set-msg-time-color').value;

const charAvatarUrl = document.getElementById('preview-char-avatar').src;
if (charAvatarUrl) appSettings.charAvatar = charAvatarUrl;
const userAvatarUrl = document.getElementById('preview-user-avatar').src;
if (userAvatarUrl) appSettings.userAvatar = userAvatarUrl;
const chatBgUrl = document.getElementById('preview-chat-bg').src;
if (chatBgUrl && chatBgUrl !== window.location.href) {
appSettings.chatBg = chatBgUrl;
appSettings.chatBgIsDark = await analyzeImageBrightness(appSettings.chatBg);
}
saveSettingsToStorage(); applySettings(); closeModal(); closeMenus();
}

function closeModal() {
// If input modal is visible, close ONLY the input modal
if(modal && modal.classList.contains('show')) {
modal.classList.remove('show');
currentConfirmAction = null; // Cleanup current action
return;
}
// If input modal is not visible, close the settings modal
if(chatSettingsModal && chatSettingsModal.classList.contains('show')) {
chatSettingsModal.classList.remove('show');
}
currentConfirmAction = null;
}
function toBase64(file) { return new Promise((resolve, reject) => { const reader = new FileReader(); reader.readAsDataURL(file); reader.onload = () => resolve(reader.result); reader.onerror = error => reject(error); }); }

function closeMenus() {
if(actionMenu) actionMenu.classList.remove('open');
if(plusButton) plusButton.classList.remove('active');
if(emojiMenu) emojiMenu.classList.remove('open');
}

function initStickers() {
if(!emojiMenu) return;
emojiMenu.innerHTML = '';
stickerList.forEach(s => {
const div = document.createElement('div');
div.className = 'sticker-item';
div.onclick = () => sendSticker(s.name, s.url);
div.innerHTML = `<img src="${s.url}" class="sticker-img"><span class="sticker-name">${s.name}</span>`;
emojiMenu.appendChild(div);
});
}

function handleAction(type) {
if (type === 'location') openModal('发送位置', [{ placeholder: '地点名称' }], (v) => sendLocation(v[0]));
else if (type === 'transfer') openModal('转账给对方', [{ placeholder: '金额 (如：¥ 520.00)' }, { placeholder: '备注 (可选)' }], (v) => sendTransfer(v[0], v[1]));
else if (type === 'file') openModal('发送文件', [{ placeholder: '文件名称 (如：报告.pdf)' }], (v) => sendFile(v[0]));
else if (type === 'voice') {
    openModal('发送语音', [{ placeholder: '时长 (秒)' }, { placeholder: '转文字内容' }], (v) => sendVoice(v[0], v[1]));
    
    // Check if plugin exists for audio upload
    // Uses the new custom plugin API name
    const uploadApi = (window.parent && (window.parent.__phone_uploadFile || window.parent.__uploadFileByPlugin)) || 
                      (window.top && (window.top.__phone_uploadFile || window.top.__uploadFileByPlugin));
    
    if (uploadApi) {
        const div = document.createElement('div');
        div.style.marginTop = '12px'; div.style.textAlign = 'center';
        div.innerHTML = '<span style="color:#666;font-size:13px;text-decoration:underline;cursor:pointer;">上传音频文件</span>';
        div.onclick = () => { document.getElementById('voice-upload-input').click(); closeModal(); };
        document.getElementById('modal-inputs-container').appendChild(div);
    }
}
else if (type === 'settings') openChatSettings();
else if (type === 'photo') photoInput.click();
}

function openModal(title, fields, confirmCallback) {
modalTitle.textContent = title; modalInputsContainer.innerHTML = '';
fields.forEach(field => { const input = document.createElement('input'); input.type = 'text'; input.className = 'modal-input'; input.placeholder = field.placeholder; modalInputsContainer.appendChild(input); });
currentConfirmAction = confirmCallback; modal.classList.add('show');
}

async function sendLocation(addr) { try { const t = getTime(); const u = window.userName || '{{user}}'; renderMessageToUI({ header: `[${u}|位置|${t}]`, body: addr, isUser: true, type: 'location' }); await rebuildAndSaveHistory(); } catch (e) {} }
async function sendTransfer(amt, note) { try { const t = getTime(); const u = window.userName || '{{user}}'; renderMessageToUI({ header: `[${u}|转账|${t}]`, body: `${amt}|${note||''}`, isUser: true, type: 'transfer' }); await rebuildAndSaveHistory(); } catch (e) {} }
async function sendFile(fn) { try { const t = getTime(); const u = window.userName || '{{user}}'; renderMessageToUI({ header: `[${u}|文件|${t}]`, body: fn, isUser: true, type: 'file' }); await rebuildAndSaveHistory(); } catch (e) {} }
async function sendVoice(dur, txt) { try { const t = getTime(); const u = window.userName || '{{user}}'; renderMessageToUI({ header: `[${u}|语音|${t}]`, body: `${dur}|${txt||''}`, isUser: true, type: 'voice' }); await rebuildAndSaveHistory(); } catch (e) {} }
async function sendPhoto(base64) { try { const t = getTime(); const u = window.userName || '{{user}}'; renderMessageToUI({ header: `[${u}|图片|${t}]`, body: base64, isUser: true, type: 'photo' }); await rebuildAndSaveHistory(); } catch (e) {} }
async function sendVoiceFile(url) { try { const t = getTime(); const u = window.userName || '{{user}}'; renderMessageToUI({ header: `[${u}|语音|${t}]`, body: url, isUser: true, type: 'voice' }); await rebuildAndSaveHistory(); } catch (e) {} }

async function sendSticker(name, url) {
const filename = url.split('/').pop();
const bodyText = name + filename;
const t = getTime();
const u = window.userName || '{{user}}';
renderMessageToUI({ header: `[${u}|表情包|${t}]`, body: bodyText, isUser: true, type: 'sticker' });
await rebuildAndSaveHistory();
}

async function sendMessage() {
closeMenus(); const text = messageInput.value.trim();
if (!text) { if (typeof generate !== 'undefined') { showTypingIndicator(); triggerGenerate(); } return; }
const t = getTime(); const u = window.userName || '{{user}}'; renderMessageToUI({ header: `[${u}|${t}]`, body: text, isUser: true });
messageInput.value = ''; adjustTextareaHeight(); await rebuildAndSaveHistory();
}

function getTime() {
if (appSettings.customTime && /^\d{1,2}:\d{2}$/.test(appSettings.customTime)) return appSettings.customTime;
const now = new Date(); return `${now.getHours().toString().padStart(2,'0')}:${now.getMinutes().toString().padStart(2,'0')}`;
}

function renderMessageToUI(msg) {
if(!chatMessages) return;
const row = document.createElement('div'); row.className = `message-row ${msg.isUser ? 'sent' : 'received'}`;
const avatar = document.createElement('img'); avatar.className = 'avatar'; avatar.src = msg.isUser ? appSettings.userAvatar : appSettings.charAvatar;

const container = document.createElement('div'); container.className = 'msg-container';
const nameEl = document.createElement('div'); nameEl.className = 'msg-name';
let displayName = msg.isUser ? (window.userName || '{{user}}') : (window.charName || '{{char}}');
if (msg.header) {
const parts = msg.header.replace(/^\[|\]$/g, '').split('|');
if (parts.length > 0 && parts[0]) displayName = parts[0];
}
nameEl.textContent = displayName;
container.appendChild(nameEl);

const wrapper = document.createElement('div'); wrapper.className = 'msg-wrapper';

let el;
const isLoc = msg.type === 'location' || (msg.header && msg.header.includes('位置'));
const isTra = msg.type === 'transfer' || (msg.header && msg.header.includes('转账'));
const isFile = msg.type === 'file' || (msg.header && msg.header.includes('文件'));
const isVoice = msg.type === 'voice' || (msg.header && msg.header.includes('语音'));
const isPhoto = msg.type === 'photo' || (msg.header && msg.header.includes('图片'));
const isSticker = msg.type === 'sticker' || (msg.header && msg.header.includes('表情包'));

const timeMatch = msg.header ? msg.header.match(/\|(\d{2}:\d{2})/) : null;
const timeStr = timeMatch ? timeMatch[1] : getTime();
const timeEl = document.createElement('div'); timeEl.className = 'msg-time'; timeEl.textContent = timeStr;

let displayBody = msg.body;
let displayThought = msg.thought || '';
if (!displayThought && displayBody) {
const thoughtMatch = displayBody.match(/^([\s\S]*?)\*([^\*]+)\*\s*$/);
if (thoughtMatch) { displayBody = thoughtMatch[1].trim(); displayThought = thoughtMatch[2].trim(); }
}

if (isLoc) {
el = document.createElement('div'); el.className = `location-card ${msg.isUser ? 'sent' : 'received'}`;
el.innerHTML = `<div class="location-info"><div class="location-name">${displayBody}</div></div><div class="location-map"><svg class="location-pin" viewBox="0 0 24 24"><path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7z"></path><circle cx="12" cy="9" r="2.5" fill="#fff"/></svg></div>`;
} else if (isTra) {
const parts = displayBody.split('|');
el = document.createElement('div'); el.className = `transfer-card ${msg.isUser ? 'sent' : 'received'}`;
el.innerHTML = `<div class="transfer-top"><div class="transfer-icon-circle"><svg viewBox="0 0 24 24"><path d="M7 10h14l-4-4"></path><path d="M17 14H3l4 4"></path></svg></div><div class="transfer-content"><div class="transfer-amount">${parts[0]||'¥ 0.00'}</div><div class="transfer-note">${parts[1]||'转账给您'}</div></div></div><div class="transfer-bottom">转账</div>`;
} else if (isFile) {
el = document.createElement('div'); el.className = `file-card ${msg.isUser ? 'sent' : 'received'}`;
el.innerHTML = `<div class="file-info"><div class="file-name">${displayBody}</div><div class="file-size">128 KB</div></div><div class="file-icon"><svg viewBox="0 0 24 24"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z" fill="#eee"></path><polyline points="14 2 14 8 20 8" fill="#ddd"></polyline><text x="50%" y="18" font-size="6" fill="#888" text-anchor="middle" font-family="Arial">FILE</text></svg></div>`;
} else if (isVoice) {
// Detect if it is a URL/File or a simulated message
const isUrl = displayBody.trim().match(/^(\/|http)/);
if (isUrl) {
    el = document.createElement('div'); el.className = `voice-card ${msg.isUser ? 'sent' : 'received'}`;
    el.style.width = '220px'; el.style.padding = '8px 12px';
    // Use HTML Audio element for actual files
    el.innerHTML = `<audio controls src="${displayBody}" style="width: 100%; height: 32px; border-radius: 16px; outline: none;"></audio>`;
    // Stop propagation to prevent card click events interfering with controls
    el.onclick = (e) => e.stopPropagation();
    if (msg.isUser) { el.style.backgroundColor = appSettings.userBubble; }
    else { el.style.backgroundColor = appSettings.charBubble; }
} else {
    // Legacy visual simulation
    const parts = displayBody.split('|'); const dur = parseInt(parts[0]) || 5; const txt = parts.slice(1).join('|');
    const width = Math.max(60, 40 + txt.length * 10);
    el = document.createElement('div'); el.className = `voice-card ${msg.isUser ? 'sent' : 'received'}`; el.style.width = width + 'px';
    let waves = ''; for(let i=0;i<4;i++) waves += `<div class="wave" style="height:${8 + Math.random()*8}px"></div>`;
    el.innerHTML = `<div class="voice-bar"><div class="voice-duration">${dur}"</div><div class="voice-waves">${waves}</div></div><div class="voice-text ${txt.length > 15 ? 'multiline' : ''}">${txt}</div>`;
    el.onclick = (e) => { if(!activeDeleteBtn) el.classList.toggle('show-text'); };
    if (msg.isUser) { el.style.backgroundColor = appSettings.userBubble; el.style.color = appSettings.userText; }
    else { el.style.backgroundColor = appSettings.charBubble; el.style.color = appSettings.charText; }
}
} else if (isSticker) {
el = document.createElement('div'); el.className = `sticker-bubble ${msg.isUser ? 'sent' : 'received'}`;
let src = displayBody;
const fileMatch = displayBody.match(/([a-zA-Z0-9_-]+\.[a-zA-Z0-9]+)$/);
if (fileMatch && !displayBody.startsWith('http')) { src = 'https://files.catbox.moe/' + fileMatch[1]; }
el.innerHTML = `<img src="${src}">`;
el.dataset.stickerBody = displayBody;
} else if (isPhoto) {
el = document.createElement('div'); el.className = `photo-card ${msg.isUser ? 'sent' : 'received'}`;
el.innerHTML = `<img src="${displayBody}">`;
} else {
el = document.createElement('div'); el.className = `bubble ${msg.isUser ? 'bubble-sent' : 'bubble-received'}`; el.textContent = displayBody;
if (msg.isUser) { el.style.backgroundColor = appSettings.userBubble; el.style.color = appSettings.userText; }
else { el.style.backgroundColor = appSettings.charBubble; el.style.color = appSettings.charText; }
}

if (msg.header) el.dataset.fullHeader = msg.header.startsWith('[') ? msg.header : `[${msg.header}]`;
else { const n = msg.isUser ? (window.userName || '{{user}}') : (window.charName || '{{char}}'); const t = new Date().toTimeString().slice(0,5); el.dataset.fullHeader = `[${n}|${t}]`; }

addLongPressHandler(el);
wrapper.appendChild(el); wrapper.appendChild(timeEl); container.appendChild(wrapper);

if (displayThought) {
const thoughtEl = document.createElement('div'); thoughtEl.className = 'msg-thought';
thoughtEl.textContent = displayThought; container.appendChild(thoughtEl);
}

row.appendChild(avatar); row.appendChild(container); chatMessages.appendChild(row); chatMessages.scrollTop = chatMessages.scrollHeight;
}

async function rebuildAndSaveHistory() {
try { if (typeof getCurrentMessageId === 'undefined') return; const cn = window.charName || '{{char}}'; const rows = Array.from(chatMessages.children); let nc = '';
for (const row of rows) {
if (row.id === 'typing-bubble' || row.classList.contains('delete-btn')) continue;
const el = row.querySelector('.bubble, .location-card, .transfer-card, .file-card, .voice-card, .photo-card, .sticker-bubble'); if (!el) continue;
let t = "", h = el.dataset.fullHeader;
const thoughtEl = row.querySelector('.msg-thought');
const thoughtSuffix = thoughtEl ? `*${thoughtEl.textContent}*` : '';
if (el.classList.contains('bubble')) t = el.textContent;
else if (el.classList.contains('location-card')) t = el.querySelector('.location-name').textContent;
else if (el.classList.contains('transfer-card')) t = `${el.querySelector('.transfer-amount').textContent}|${el.querySelector('.transfer-note').textContent}`;
else if (el.classList.contains('file-card')) t = el.querySelector('.file-name').textContent;
else if (el.classList.contains('voice-card')) {
    // Handle both URL audio and text simulated audio for history reconstruction
    const audioEl = el.querySelector('audio');
    if (audioEl) {
        t = audioEl.getAttribute('src');
    } else {
        t = `${el.querySelector('.voice-duration').textContent.replace('"','')}|${el.querySelector('.voice-text').textContent}`;
    }
}
else if (el.classList.contains('sticker-bubble')) { t = el.dataset.stickerBody || el.querySelector('img').src; }
else if (el.classList.contains('photo-card')) t = el.querySelector('img').src;
if (h && t) nc += `${h}${t}${thoughtSuffix}\n`;
}
const tn = 'chat', sn = String(cn).replace('{{char}}', window.charName || '{{char}}');
const fh = `<fphone>\n<${tn}:${sn}>\n${nc.trim()}\n</${tn}>\n</fphone>`;
await setChatMessages([{ message_id: getCurrentMessageId(), message: fh }], { refresh: 'none' });
} catch (e) { console.error(e); }
}

if (typeof eventOn !== 'undefined') {
const removeTyping = () => { const tb = document.getElementById('typing-bubble'); if (tb) tb.remove(); };
eventOn(iframe_events.GENERATION_ENDED, (resp) => {
removeTyping();
let rt = typeof resp === 'string' ? resp : (resp.text || '');
rt = rt.replace(/<fphone>|<\/fphone>|<\/?chat(:.*?)?>/gi, '').trim();
parseMessages(rt).forEach(msg => renderMessageToUI(msg)); rebuildAndSaveHistory();
});
eventOn(iframe_events.GENERATION_STOPPED, removeTyping);
} else {
// 如果 eventOn 不可用（例如在某些旧版或特殊环境中），使用 MutationObserver 监听 body 变化作为替代
// 许多 ST 版本在生成时会给 body 添加 'generating' 类或其他标识，或者我们可以监听消息列表的变化
const observer = new MutationObserver((mutations) => {
    const tb = document.getElementById('typing-bubble');
    if (tb) {
        // 如果发现新消息被添加到了聊天区域（非 typing-bubble），则认为生成可能结束了
        // 这里需要更精确的逻辑，但作为兜底，我们可以检查是否有新内容
    }
});
// observer.observe(document.body, { attributes: true, childList: true, subtree: true });
}

function parseMessages(txt) {
const lines = txt.split('\n'), res = [], dr = /^\d{1,2}月\d{1,2}日$/, hr = /^\[([^\]]+)\]/, cn = window.charName || '{{char}}';
for (const l of lines) {
const tr = l.trim(); if (!tr) continue; if (dr.test(tr)) { res.push({ type: 'date', body: tr }); continue; }
const m = tr.match(hr);
if (m) {
const hc = m[1];
let b = tr.substring(m[0].length).trim();
let thought = '';
const thoughtMatch = b.match(/^([\s\S]*?)\*([^\*]+)\*\s*$/);
if (thoughtMatch) { b = thoughtMatch[1].trim(); thought = thoughtMatch[2].trim(); }
let type = 'text';
if (hc.includes('位置')) type = 'location'; else if (hc.includes('转账')) type = 'transfer'; else if (hc.includes('文件')) type = 'file'; else if (hc.includes('语音')) type = 'voice'; else if (hc.includes('图片')) type = 'photo';
else if (hc.includes('表情包')) type = 'sticker';
// Determine if message is from user or char based on header content
const isUser = hc.startsWith('User') || hc.includes(window.userName || '{{user}}');
res.push({ header: hc, body: b, type: type, thought: thought, isUser: isUser });
} else res.push({ header: `${cn}|00:00`, body: tr, type: 'text', isUser: false });
}
return res;
}

function loadInitialChat() {
if(!chatMessages) return;
chatMessages.innerHTML = '';
try { if (typeof getCurrentMessageId === 'undefined') return; const h = getChatMessages(getCurrentMessageId()); if (!h?.[0]?.message) return;
const m = h[0].message.match(/<fphone>([\s\S]*?)<\/fphone>/i); if (!m) return;
const c = m[1].replace(/<\/?chat(:.*?)?>/gi, '').trim(); parseMessages(c).forEach(msg => renderMessageToUI(msg));
} catch (e) {}
}

function triggerGenerate() {
const cn = window.charName || '{{char}}', t = getTime();
const p = `[系统指令] 当前时间${t}。请模仿手机短信连发，回复 2-5 条简短消息。每条必须以 [${cn}|${t}] 开头。`;
generate({ injects: [{ role: 'system', content: p, position: 'in_chat', depth: 0, should_scan: true }], should_stream: false, max_chat_history: 300 });
}
function showTypingIndicator() {
const row = document.createElement('div'); row.id = 'typing-bubble'; row.className = 'message-row received';
const av = document.createElement('img'); av.className = 'avatar'; av.src = appSettings.charAvatar;
const el = document.createElement('div'); el.className = 'bubble bubble-received';
el.innerHTML = '<div class="typing-dots"><span></span><span></span><span></span></div>'; el.style.backgroundColor = appSettings.charBubble;
row.appendChild(av); row.appendChild(el); chatMessages.appendChild(row); chatMessages.scrollTop = chatMessages.scrollHeight;
// 点击气泡移除动画
row.onclick = () => row.remove();
}
function adjustTextareaHeight() { messageInput.style.height = 'auto'; messageInput.style.height = messageInput.scrollHeight + 'px'; }
function clearDeleteButton() { if (activeDeleteBtn) { activeDeleteBtn.remove(); activeDeleteBtn = null; } document.querySelectorAll('.delete-mode').forEach(el => el.classList.remove('delete-mode')); }
function executeDelete(el) { const r = el.closest('.message-row'); r.style.transform = 'scale(0)'; setTimeout(async () => { r.remove(); clearDeleteButton(); await rebuildAndSaveHistory(); }, 200); }
function addLongPressHandler(el) {
let timer; const start = (e) => { if(e.target.closest('.delete-btn')) return; el.classList.add('pressing'); timer = setTimeout(() => { el.classList.remove('pressing'); showDeleteButton(el); }, 500); };
const cancel = () => { clearTimeout(timer); el.classList.remove('pressing'); }; el.addEventListener('mousedown', start); el.addEventListener('touchstart', start, {passive:true}); ['mouseup','mouseleave','touchend','touchmove'].forEach(ev => el.addEventListener(ev, cancel));
}
function showDeleteButton(el) {
clearDeleteButton(); el.classList.add('delete-mode'); const btn = document.createElement('div'); btn.className = 'delete-btn';
btn.innerHTML = `<svg viewBox="0 0 24 24"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>`;
btn.onclick = (e) => { e.stopPropagation(); executeDelete(el); }; el.appendChild(btn); activeDeleteBtn = btn;
}
document.onclick = (e) => { if(activeDeleteBtn && !e.target.closest('.location-card, .transfer-card, .file-card, .bubble, .voice-card, .photo-card, .sticker-bubble')) clearDeleteButton(); };

function init() {
// Initialize references
phoneContainer = document.getElementById('phone-container');
homeScreen = document.getElementById('home-screen');
chatScreen = document.getElementById('chat-screen');
settingsScreen = document.getElementById('settings-screen');
chatMessages = document.getElementById('chat-messages');
messageInput = document.getElementById('message-input');
sendButton = document.getElementById('send-button');
plusButton = document.getElementById('plus-button');
emojiButton = document.getElementById('emoji-button');
actionMenu = document.getElementById('action-menu');
emojiMenu = document.getElementById('emoji-menu');
modal = document.getElementById('input-modal');
modalTitle = document.getElementById('modal-title');
modalInputsContainer = document.getElementById('modal-inputs-container');
modalConfirmBtn = document.getElementById('modal-confirm-btn');
chatSettingsModal = document.getElementById('chat-settings-modal');
headerTitle = document.getElementById('header-title');
clockEl = document.getElementById('clock');
homeClockEl = document.getElementById('home-clock');
statusBar = document.getElementById('status-bar');
photoInput = document.getElementById('photo-upload-input');

// Helper to correct relative URLs for iframe context if necessary
const fixUrl = (u) => (u && !u.startsWith('http') && !u.startsWith('/')) ? '/' + u : u;

// Bind Events
if(photoInput) photoInput.addEventListener('change', async (e) => {
if (e.target.files && e.target.files[0]) {
    const file = e.target.files[0];
    try {
        // 优先使用新插件的接口 __phone_uploadImage
        // 兼容 Olivia 插件的接口 __uploadImageByPlugin
        const uploadApi = (window.parent && (window.parent.__phone_uploadImage || window.parent.__uploadImageByPlugin)) || 
                          (window.top && (window.top.__phone_uploadImage || window.top.__uploadImageByPlugin));
        
        if (uploadApi) {
            const res = await uploadApi(file);
            sendPhoto(fixUrl(res.url));
        } else {
            // 坚决不使用 base64 回退，避免卡顿，强制提示用户安装插件
            alert("插件未安装或未加载！\n\n请安装并启用 'SillyTavern-Phone-Support' 插件。\n这能确保图片以文件形式保存，而不是 Base64 长文本，从而避免卡顿。");
        }
    } catch (err) {
        alert("图片上传出错: " + err.message);
        console.error(err);
    }
    e.target.value = '';
}
});

const voiceInput = document.getElementById('voice-upload-input');
if(voiceInput) voiceInput.addEventListener('change', async (e) => {
    if (e.target.files && e.target.files[0]) {
        const file = e.target.files[0];
        try {
            // 优先使用新插件的接口 __phone_uploadFile
            // 兼容 Olivia 插件的接口 __uploadFileByPlugin
            const uploadApi = (window.parent && (window.parent.__phone_uploadFile || window.parent.__uploadFileByPlugin)) || 
                              (window.top && (window.top.__phone_uploadFile || window.top.__uploadFileByPlugin));
            
            if (uploadApi) {
                const res = await uploadApi(file);
                sendVoiceFile(fixUrl(res.url));
            } else {
                 alert("插件未安装或未加载！\n\n请安装并启用 'SillyTavern-Phone-Support' 插件。\n这能确保音频以文件形式保存，避免卡顿。");
            }
        } catch (err) {
            alert("音频上传失败: " + err.message);
            console.error(err);
        }
        e.target.value = '';
    }
});

if(plusButton) plusButton.addEventListener('click', () => {
if (actionMenu.classList.contains('open')) closeMenus();
else { closeMenus(); actionMenu.classList.add('open'); plusButton.classList.add('active'); clearDeleteButton(); setTimeout(() => chatMessages.scrollTop = chatMessages.scrollHeight, 300); }
});
if(emojiButton) emojiButton.addEventListener('click', () => {
if (emojiMenu.classList.contains('open')) closeMenus();
else { closeMenus(); emojiMenu.classList.add('open'); setTimeout(() => chatMessages.scrollTop = chatMessages.scrollHeight, 300); }
});
if(messageInput) {
messageInput.addEventListener('focus', closeMenus);
messageInput.oninput = adjustTextareaHeight;
messageInput.onkeydown = (e) => { if(e.key==='Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); } };
}
if(sendButton) sendButton.onclick = sendMessage;
if(modalConfirmBtn) modalConfirmBtn.onclick = (e) => {
if(e) e.preventDefault();
if (currentConfirmAction) {
const inputs = modalInputsContainer.querySelectorAll('input');
const values = Array.from(inputs).map(i => i.value.trim());
if (values[0]) {
currentConfirmAction(values);
// Only remove the 'show' class from the input modal, explicitly do not call closeModal
if(modal) modal.classList.remove('show');
currentConfirmAction = null; // Clean up immediately after execution
}
}
};

loadSettings();
const defaultAvatar = 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0iI2IwYjBiMCI+PHJlY3Qgd2lkdGg9IjI0IiBoZWlnaHQ9IjI0IiBmaWxsPSIjZjJmMmYyIi8+PHBhdGggZD0iTTEyIDEyYzIuMjEgMCA0LTEuNzkgNC00cy0xLjc5LTQtNC00LTQgMS43OS00IDQgMS43OSA0IDQgNHptMCAyYy0yLjY3IDAtOCAxLjM0LTggNHYyaDE2di0yYzAtMi42Ni01LjMzLTQtOC00eiIvPjwvc3ZnPg==';
if(!appSettings.charAvatar) appSettings.charAvatar = defaultAvatar;
if(!appSettings.userAvatar) appSettings.userAvatar = defaultAvatar;
applySettings();
if(headerTitle) headerTitle.textContent = window.charName || '{{char}}';
updateClock();
initStickers();
setInterval(updateClock, 1000);
try { loadInitialChat(); setTimeout(loadInitialChat, 500); } catch(e){}
}

// Attach globally
window.openChat = openChat;
window.goBack = goBack;
window.openSettings = openSettings;
window.closeSettings = closeSettings;
window.openChatSettings = openChatSettings;
window.saveHomeSettings = saveHomeSettings;
window.saveChatSettings = saveChatSettings;
window.handleAction = handleAction;
window.closeModal = closeModal;
window.handleUploadUrl = handleUploadUrl;

// Initialize on Load
if (document.readyState === 'loading') {
document.addEventListener('DOMContentLoaded', init);
} else {
init();
}
})();
</script>
</body>
</html>
